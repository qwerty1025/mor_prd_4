<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>五寮尖 V17.0 iPhone版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* 全螢幕鎖定設定 */
        html, body { 
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            background-color: #fff; font-family: 'Noto Sans TC', sans-serif;
            touch-action: pan-x; /* 只允許左右滑動 */
        }
        [v-cloak] { display: none; }

        /* 版面結構 */
        #app { height: 100%; display: flex; flex-direction: column; }
        header { flex: 0 0 60px; } /* 固定頭部高度 */
        
        /* 表格容器：核心 */
        .table-viewport {
            flex: 1; /* 佔滿剩餘高度 */
            overflow-x: auto; /* 允許左右捲動 */
            overflow-y: hidden; /* 禁止上下捲動 */
            position: relative;
            background: #fff;
        }

        .full-height-table {
            height: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed; /* 固定佈局 */
        }

        /* 欄位設定 */
        .col-label {
            position: sticky; left: 0; z-index: 20;
            width: 100px; /* 固定左側標題寬度 */
            background-color: #f8fafc;
            border-right: 2px solid #e2e8f0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        
        .col-data {
            width: 35vw; /* iPhone 15 剛好顯示約 2.8 天 */
            min-width: 130px;
        }

        /* 列高設定：自動均分 */
        tr { height: 8.5%; } /* 100% 除以約 11-12 行 */
        
        th, td {
            padding: 0 4px; text-align: center;
            border-bottom: 1px solid #f1f5f9;
            border-right: 1px solid #f8fafc;
            white-space: nowrap;
        }

        /* 字體與顏色 */
        .time-label { font-size: 11px; color: #64748b; font-weight: 700; display: block; margin-bottom: 2px; }
        .row-title { font-size: 13px; font-weight: 700; color: #334155; }
        
        .num-val { font-family: 'Roboto Mono', monospace; font-size: 17px; letter-spacing: -0.5px; font-weight: 500; }
        .val-plus { color: #10b981; } /* 綠色 + */
        .val-minus { color: #ef4444; } /* 紅色 - */
        .val-blue { color: #3b82f6; font-weight: 700; } /* 藍色 */
        
        /* 今日高亮 */
        .is-today { background-color: #f0f9ff; box-shadow: inset 2px 0 0 #3b82f6, inset -2px 0 0 #3b82f6; }
        .is-today-header { background-color: #eff6ff !important; border-bottom: 2px solid #3b82f6; }
        
        /* 底部結餘特別大 */
        .row-balance { background-color: #f8fafc; border-top: 2px solid #cbd5e1; height: 10%; }
        .row-balance .num-val { font-size: 20px; font-weight: 900; color: #1e40af; }

        /* 底部參考資訊 */
        .row-ref { height: 8%; background-color: #f1f5f9; font-size: 11px; color: #64748b; }

        /* 編輯抽屜 */
        .drawer-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 40; backdrop-filter: blur(2px); }
        .drawer { 
            position: fixed; bottom: 0; left: 0; right: 0; background: white; 
            z-index: 50; border-radius: 20px 20px 0 0; 
            transform: translateY(100%); transition: transform 0.25s;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            padding-bottom: 20px;
        }
        .drawer.open { transform: translateY(0); }

        .manual-dot { width: 6px; height: 6px; background: #3b82f6; border-radius: 50%; position: absolute; top: 8px; right: 8px; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <header class="flex justify-between items-center px-5 bg-white shadow-sm border-b z-30">
        <div>
            <div class="text-[10px] text-slate-400 font-bold">今日結餘 ({{ todayStr }})</div>
            <div class="text-3xl font-black text-slate-800 num-font">{{ todayEndStock.toFixed(1) }} <span class="text-sm text-slate-400">L</span></div>
        </div>
        <button @click="scrollToToday" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-bold shadow-sm">
            <i class="fas fa-calendar-day mr-1"></i> 回今日
        </button>
    </header>

    <div class="table-viewport" ref="scrollContainer">
        <table class="full-height-table">
            <thead>
                <tr>
                    <th class="col-label bg-slate-50">
                        <div class="text-xs text-slate-400">項目 \ 日期</div>
                    </th>
                    <th v-for="d in days" :key="d.key" class="col-data" :class="{'is-today-header': d.isToday, 'bg-orange-50': d.isWeekend && !d.isToday}">
                        <div class="flex flex-col items-center py-2">
                            <span class="text-lg font-black" :class="d.isWeekend?'text-red-500':'text-slate-700'">{{ d.weekDay }}</span>
                            <span class="text-[10px] text-slate-500 font-bold">{{ d.dateStr }}</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="col-label">
                        <span class="time-label">07:00</span>
                        <span class="row-title"><i class="fas fa-cube text-slate-300 w-4 text-center"></i> 期初</span>
                    </td>
                    <td v-for="d in days" :key="d.key" @click="edit('inventory', d)" class="relative" :class="{'is-today': d.isToday}">
                        <span class="num-val text-slate-400 italic">{{ d.startStock.toFixed(1) }}</span>
                        <div v-if="d.isManual.inventory" class="manual-dot"></div>
                    </td>
                </tr>

                <tr>
                    <td class="col-label">
                        <span class="time-label">08:00</span>
                        <span class="row-title"><i class="fas fa-sun text-emerald-500 w-4 text-center"></i> 晨收</span>
                    </td>
                    <td v-for="d in days" :key="d.key" @click="edit('harvestAM', d)" :class="{'is-today': d.isToday}">
                        <span class="num-val val-plus">+{{ d.harvestAM }}</span>
                    </td>
                </tr>

                <tr>
                    <td class="col-label">
                        <span class="time-label">10:00</span>
                        <span class="row-title"><i class="fas fa-home text-blue-500 w-4 text-center"></i> 宅配</span>
                        <div class="text-[9px] text-slate-400 scale-90 origin-left">家庭號/大新</div>
                    </td>
                    <td v-for="d in days" :key="d.key" @click="edit('checklist', d)" :class="{'is-today': d.isToday}">
                        <span v-if="d.deliveryHome > 0" class="num-val val-blue">-{{ d.deliveryHome.toFixed(1) }}</span>
                        <span v-else class="text-slate-200">-</span>
                    </td>
                </tr>

                <tr>
                    <td class="col-label">
                        <span class="time-label">13:00</span>
                        <span class="row-title"><i class="fas fa-blender text-amber-500 w-4 text-center"></i> 加班</span>
                        <div class="text-[9px] text-slate-400 scale-90 origin-left">加工/快閃/團購</div>
                    </td>
                    <td v-for="d in days" :key="d.key" @click="edit('process_group', d)" :class="{'is-today': d.isToday}">
                        <div v-if="d.otherOut > 0" class="num-val text-amber-600 font-bold">-{{ d.otherOut.toFixed(1) }}</div>
                        <span v-else class="text-slate-200">-</span>
                    </td>
                </tr>

                <tr>
                    <td class="col-label">
                        <span class="time-label">20:00</span>
                        <span class="row-title"><i class="fas fa-moon text-indigo-500 w-4 text-center"></i> 晚收</span>
                    </td>
                    <td v-for="d in days" :key="d.key" @click="edit('harvestPM', d)" :class="{'is-today': d.isToday}">
                        <span class="num-val val-plus">+{{ d.harvestPM }}</span>
                    </td>
                </tr>

                <tr class="bg-red-50/30">
                    <td class="col-label">
                        <span class="row-title text-red-600"><i class="fas fa-truck text-red-400 w-4 text-center"></i> 晨配備貨</span>
                        <div class="text-[9px] text-red-400 scale-90 origin-left leading-tight mt-1">扣今日庫存<br>供明早配送</div>
                    </td>
                    <td v-for="d in days" :key="d.key" @click="edit('deliveryRoute', d)" :class="{'is-today': d.isToday}">
                        <div class="num-val val-minus font-bold">-{{ d.tomorrowRoute.toFixed(1) }}</div>
                        <div class="text-[9px] text-red-300">for {{ d.tomorrowDate }}</div>
                    </td>
                </tr>
                
                <tr>
                    <td class="col-label">
                        <span class="row-title text-slate-400">調節</span>
                    </td>
                    <td v-for="d in days" :key="d.key" @click="edit('variance', d)" :class="{'is-today': d.isToday}">
                        <span v-if="d.variance.val !== 0" :class="d.variance.val>0?'text-green-500':'text-red-500'" class="font-bold text-sm">
                            {{ d.variance.val>0?'+':'' }}{{ d.variance.val }}
                        </span>
                        <span v-else class="text-slate-100">-</span>
                    </td>
                </tr>

                <tr class="row-balance shadow-md">
                    <td class="col-label bg-slate-50 border-t-2 border-slate-300">
                        <span class="time-label">22:00</span>
                        <span class="row-title text-blue-800">結餘</span>
                    </td>
                    <td v-for="d in days" :key="d.key" class="border-t-2 border-slate-300" :class="{'is-today': d.isToday}">
                        <span class="num-val">{{ d.endStock.toFixed(1) }}</span>
                    </td>
                </tr>

                <tr class="row-ref">
                    <td class="col-label">
                        <span class="font-bold text-slate-500">參考資訊</span>
                        <div class="text-[9px]">瓶數統計</div>
                    </td>
                    <td v-for="d in days" :key="d.key" :class="{'is-today': d.isToday}">
                        <div v-if="d.bottleStats.big > 0 || d.bottleStats.small > 0" class="flex flex-col gap-0.5">
                            <div>大: <span class="text-slate-700 font-bold">{{ d.bottleStats.big }}</span></div>
                            <div>金: <span class="text-slate-700 font-bold">{{ d.bottleStats.small }}</span></div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div v-if="drawer.show" class="drawer-backdrop" @click="drawer.show=false"></div>
    <div class="drawer" :class="{ 'open': drawer.show }">
        <div class="flex justify-between items-center px-6 py-4 border-b">
            <div>
                <div class="text-lg font-black text-slate-800">{{ drawer.title }}</div>
                <div class="text-xs text-slate-500">{{ drawer.dateLabel }}</div>
            </div>
            <button @click="save" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg shadow-blue-200">確認</button>
        </div>
        
        <div class="p-6">
            <div class="flex items-center gap-4 mb-4">
                <button @click="adj(-1)" class="w-14 h-14 bg-slate-100 rounded-xl text-xl font-bold">-</button>
                <input v-model.number="drawer.val" type="number" step="0.1" class="flex-1 text-center text-5xl font-black text-slate-800 border-b-2 border-slate-100 focus:outline-none py-2">
                <button @click="adj(1)" class="w-14 h-14 bg-slate-100 rounded-xl text-xl font-bold">+</button>
            </div>
            
            <div v-if="['flash','process_group','variance'].includes(drawer.type)">
                <input v-model="drawer.text" type="text" placeholder="輸入備註 (地點/原因/品項)" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 font-bold text-center">
            </div>

            <div v-if="drawer.type === 'deliveryRoute'" class="text-center text-sm text-red-500 font-bold mt-2">
                <i class="fas fa-info-circle"></i> 注意：您正在設定明天的晨配量
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    const firebaseConfig = {
        apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
        authDomain: "crm-ts-1225-001.firebaseapp.com",
        databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
        projectId: "crm-ts-1225-001",
        storageBucket: "crm-ts-1225-001.firebasestorage.app",
        messagingSenderId: "925760221722",
        appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
    };

    const CSV_ROUTE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF9dZUNtfJjbPIf4_3wvrJoVIv7WxGrXKEit9V0ou25BA9L1lMCEjqykH41p3f2MZc2b02nMLJXnrw/pub?gid=216467280&single=true&output=csv';
    const CSV_HOME = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF9dZUNtfJjbPIf4_3wvrJoVIv7WxGrXKEit9V0ou25BA9L1lMCEjqykH41p3f2MZc2b02nMLJXnrw/pub?gid=59343971&single=true&output=csv';

    createApp({
        setup() {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database().ref('milkBankV15');
            const scrollContainer = ref(null);
            
            const rawRoute = ref([]);
            const rawHome = ref([]);
            const savedData = ref({});
            const drawer = ref({ show:false, type:'', val:0, text:'' });
            
            const START = new Date('2026-02-04');
            const WEEK = ['日','一','二','三','四','五','六'];
            const todayKey = new Date().toISOString().split('T')[0];

            onMounted(async () => {
                const [r1, r2] = await Promise.all([fetch(CSV_ROUTE).then(x=>x.text()), fetch(CSV_HOME).then(x=>x.text())]);
                parseRoute(r1); parseHome(r2);
                
                db.on('value', snap => {
                    savedData.value = (snap.val() || {}).days || {};
                });
                
                // 自動捲動到今日
                setTimeout(scrollToToday, 1000);
            });

            const days = computed(() => {
                let stock = 0;
                const res = [];
                for(let i=0; i<30; i++) {
                    const d = new Date(START); d.setDate(START.getDate()+i);
                    const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();
                    const key = `${y}-${m}-${dd}`;
                    const nextD = new Date(d); nextD.setDate(d.getDate()+1);
                    const nextKey = `${nextD.getFullYear()}-${nextD.getMonth()+1}-${nextD.getDate()}`;
                    const iso = d.toISOString().split('T')[0];
                    const wIdx = d.getDay();
                    const s = savedData.value[key] || {};
                    const sNext = savedData.value[nextKey] || {}; // 取得明天的資料

                    // 1. 晨配備貨邏輯：顯示與扣除「明天」的晨配量
                    // 明天的 Route 預設值
                    const nextDayIdx = (wIdx + 1) % 7;
                    let tomorrowRoute = (rawRoute.value[nextDayIdx] || 0) * 0.18;
                    // 如果明天有手動修改過，優先使用
                    if(sNext.deliveryRoute !== undefined) tomorrowRoute = sNext.deliveryRoute;

                    // 2. 家庭號
                    let home = 0;
                    let big=0, small=0;
                    const defList = (wIdx>=1 && wIdx<=5) ? (rawHome.value[wIdx-1]||[]) : [];
                    const actList = s.customList || defList;
                    const chk = s.checklist || {};
                    actList.forEach(item => {
                        const st = chk[item.uuid] || 'done';
                        const fac = st==='split'?0.5 : (st==='done'?1:0);
                        if(st!=='skip') {
                            home += ((item.big*0.95)+(item.small*0.5)) * fac;
                            if(st==='done'||st==='split') { big+=item.big; small+=item.small; }
                        }
                    });

                    // 3. 其他輸出 (加工+快閃+臨時+團購)
                    const flash = s.flash?.vol || 0;
                    const process = s.process?.vol || 0;
                    const adhoc = s.adhoc?.total || 0;
                    const group = s.group?.vol || 0;
                    const otherOut = flash + process + adhoc + group;

                    const hAM = s.harvestAM ?? 13;
                    const hPM = s.harvestPM ?? 15;
                    const vari = s.variance?.val || 0;

                    if(i===0 && s.inventory===undefined) stock = 10;
                    if(s.inventory !== undefined) stock = s.inventory;
                    
                    // 結餘公式：期初 + 收 - 宅 - 雜 - 明日晨配 + 調節
                    const end = stock + hAM + hPM - home - otherOut - tomorrowRoute + vari;
                    stock = end;

                    res.push({
                        key, dateStr:`${m}/${dd}`, weekDay: WEEK[wIdx],
                        isWeekend: wIdx===0||wIdx===6, isToday: iso===todayKey,
                        startStock: s.inventory!==undefined ? s.inventory : (i===0?10:res[i-1].endStock),
                        harvestAM: hAM, harvestPM: hPM, 
                        deliveryHome: home,
                        otherOut: otherOut, // 合併顯示
                        tomorrowRoute: tomorrowRoute, // 顯示明天的量
                        tomorrowDate: `${nextD.getMonth()+1}/${nextD.getDate()}`,
                        tomorrowKey: nextKey, // 用於編輯時寫入明天
                        variance: s.variance || {val:0},
                        endStock: end,
                        bottleStats: { big, small },
                        isManual: { inventory: s.inventory!==undefined }
                    });
                }
                return res;
            });

            const todayEndStock = computed(() => days.value.find(d => d.isToday)?.endStock || 0);
            const todayStr = computed(() => {
                const t = days.value.find(d => d.isToday);
                return t ? `${t.dateStr}` : '';
            });

            // 編輯功能
            const edit = (type, d) => {
                drawer.value.show = true;
                drawer.value.type = type;
                drawer.value.dateLabel = `${d.dateStr} ${d.weekDay}`;
                
                // 特殊邏輯：編輯晨配時，其實是在編輯「明天」的資料
                if(type === 'deliveryRoute') {
                    drawer.value.key = d.tomorrowKey; // 寫入 key 指向明天
                    drawer.value.dateLabel = `備貨供 ${d.tomorrowDate} 晨配`;
                    drawer.value.val = d.tomorrowRoute;
                    drawer.value.title = "晨配備貨量";
                } 
                else if (type === 'process_group') {
                    // 簡化：這裡我們只編輯 "Adhoc/Temp" 作為代表，實際專案可能需要拆分
                    // 為求介面整潔，V17 假設這裡輸入一個總數或主要加工數
                    drawer.value.key = d.key;
                    drawer.value.title = "加班/其他消耗";
                    drawer.value.val = d.otherOut; // 顯示總數
                    // 若要精確寫回，建議 V18 再細分，這裡先寫入 process
                }
                else {
                    drawer.value.key = d.key;
                    drawer.value.title = {inventory:'期初庫存',harvestAM:'晨間收乳',harvestPM:'晚間收乳',checklist:'家庭號',variance:'庫存調節'}[type] || type;
                    
                    if(type === 'variance') {
                        drawer.value.val = d.variance.val;
                        drawer.value.text = d.variance.note || '';
                    } else if (type === 'checklist') {
                        // V17 簡化版直接輸入總量，若需點名表需呼叫 V16 的組件
                        // 這裡為了 iPhone 體驗先讓使用者能調整總數 (此處可優化)
                        drawer.value.val = d.deliveryHome; // 暫時
                    } else {
                        drawer.value.val = d[type];
                    }
                }
            };

            const save = () => {
                const { key, type, val, text } = drawer.value;
                const path = `days/${key}`;
                const up = {};

                if (type === 'deliveryRoute') {
                    // 寫入的是明天的 deliveryRoute
                    up[`${path}/deliveryRoute`] = Number(val);
                } else if (type === 'process_group') {
                    // 簡化：寫入 process
                    up[`${path}/process`] = { vol: Number(val) };
                } else if (type === 'variance') {
                    up[`${path}/variance`] = { val: Number(val), note: text };
                } else {
                    up[`${path}/${type}`] = Number(val);
                }

                db.update(up);
                drawer.value.show = false;
            };

            const scrollToToday = () => {
                const el = document.querySelector('.is-today-header');
                if(el && scrollContainer.value) {
                    scrollContainer.value.scrollTo({
                        left: el.offsetLeft - 100, // 留一點左邊距
                        behavior: 'smooth'
                    });
                }
            };

            const adj = (n) => drawer.value.val = parseFloat((drawer.value.val+n).toFixed(1));
            const parseRoute = (txt) => {
                const r = txt.split('\n').slice(1);
                const res = [0,0,0,0,0,0,0];
                r.forEach(row => {
                    const c = row.split(','); if(c.length<3)return;
                    for(let d=0; d<7; d++) {
                        let sum=0; for(let k=0; k<5; k++) sum+=(parseInt(c[(3+((d===0?6:d-1)*5))+k]?.replace(/２/g,'2'))||0);
                        res[d]+=sum;
                    }
                });
                rawRoute.value = res;
            };
            const parseHome = (txt) => {
                const r = txt.split('\n').slice(1);
                const d = [[],[],[],[],[]];
                r.forEach(row => {
                    const c = row.split(','); if(c.length<2)return;
                    for(let i=0; i<5; i++) {
                        const b=parseInt(c[2+i*2])||0, s=parseInt(c[3+i*2])||0;
                        if(b||s) d[i].push({uuid:c[0], name:c[1], big:b, small:s});
                    }
                });
                rawHome.value = d;
            };

            return { days, todayEndStock, todayStr, drawer, scrollContainer, edit, save, adj, scrollToToday };
        }
    }).mount('#app');
</script>
</body>
</html>
